\documentclass[handout]{beamer}

\input{aulas-beamer-preamble}


\title[Programação Modular]
{%
    Spring Boot: exceções, enums e opcionais%
}
\author[Prof. Pedro Pongelupe]
{
    Prof.~Pedro~Pongelupe
}
\institute[DCC / PUC Minas]
{\includegraphics[width=4cm]{puc_engesoft_logo.png} \\
	\textsc{Pontifícia Universidade Católica de Minas Gerais}\\
	Curso de Engenharia de Software
}
%\institute[DCC / PUC Minas]
%{\epsfig{file=puclogo_small_bw,width=1.5cm} \\
%	\textsc{Pontifícia Universidade Católica de Minas Gerais}\\
%	Departamento de Ciência da Computação
%}
\date[]{}

\lstset{language=Java,
   basicstyle=\scriptsize,
   commentstyle=\color{red},
   showstringspaces=false,
   numbers=none,
   numberstyle=\tiny}

\begin{document}


\selectlanguage{brazil}

\begin{frame}
   \titlepage
\end{frame}

%\addtobeamertemplate{frametitle}{}{%
%    \begin{tikzpicture}[remember picture,overlay]
%    \node[anchor=north east,yshift=2pt] at (current page.north east) {\epsfig{file=puclogo_small_bw,width=1.2cm}};
%    \end{tikzpicture}}


%\addtobeamertemplate{frametitle}{}{%
    %\begin{tikzpicture}[node distance=0cm, remember picture, overlay, every node/.style={inner sep=0,outer sep=0, node distance=0cm, baseline=0cm}]
    %\node[anchor=north east] at (current page.north east) {\epsfig{file=puclogo_small_bw,width=1cm}};
    %\end{tikzpicture}}


%\logo{\includegraphics[height=0.8cm]{puclogo_small_bw.pdf}\vspace{220pt}}


\begin{frame}
   \frametitle{Sumário}
   \tableofcontents[pausesections]
\end{frame}

%\AtBeginSection[] % Do nothing for \section*
%{
%\begin{frame}<beamer>
%\frametitle{Outline}
%\tableofcontents[currentsection]
%\end{frame}}


\addtobeamertemplate{frametitle}{}{%
	\begin{textblock*}{10mm}(.8785\textwidth,-1.75cm)
		\includegraphics[height=0.97cm]{puc_engesoft_logo.png}%\includegraphics[height=1cm]{puclogo_small_bw.pdf}
	\end{textblock*}
}
%\addtobeamertemplate{frametitle}{}{%
%   \begin{textblock*}{10mm}(.9945\textwidth,-1.71cm)
%    \includegraphics[height=1cm]{puclogo_small_bw.pdf}
%   \end{textblock*}
%}

\section{Exceções}
\subsection{Programação defensiva no Spring Boot}

\begin{frame}{Exceções no Spring Boot}
\begin{block}{Como funciona}
    As exceções no Spring Boot funcionam do mesmo jeito de quando fazemos desenvolvimentos com o Java SE.
    Ou seja, temos a utilização das mesma hierarquia de Throwable nas estruturas de \textit{try}, \textit{catch}, \textit{finally}, \textit{throw} e \textit{throws}.
\end{block}
    \begin{itemize}
        \item Lançamento
        \item Propagação
        \item Captura e tratamento
    \end{itemize}

\end{frame}
\begin{frame}[fragile]{Fluxo de execução de código}

    \begin{lstlisting}
        void metodo() {
            try {
                bloco de codigo 1;

                throw new EX();        // -- excecao EX lançada --

                bloco de código 2;     // não será executado.
            } catch (EX e) {
                bloco de código 3;     // irá capturar a exceção EX.
            } finally {
                bloco de código 4;     // será sempre executado.
            }
            bloco de código 5;        // não será executado, caso seja
            // lançada uma exceção inesperada
            // que não esteja sendo
            // tratada por um bloco catch.
        }
    \end{lstlisting}
\end{frame}



\begin{frame}{Programação defensiva no Spring Boot}

\begin{itemize}
   \begin{block}{Relembrando...}
       ``Se alguém fizer algo perigoso, você está preparado para evitar maiores consequências. (...) Você assume a responsabilidade pela sua saúde, mesmo que seja culpa do outro motorista.''
   \end{block}
\item Ideia principal na programação:
   \begin{itemize}
       \item Problemas acontecerão, mas seu programa estará preparado para lidar com eles.
    \begin{itemize}
    \item  \textit{``Garbage in, nothing out''} (lixo entra, nada sai).
    \item  \textit{``Garbage in, error message out''} (lixo entra, mensagem de erro sai).
    \item  \textit{``No garbage allowed in''} (nenhum lixo é permitido entrar).
    \end{itemize}
   \end{itemize}
\end{itemize}
\end{frame}


\begin{frame}{Protegendo seu programa de entradas inválidas}
    Utilizamos as anotações do pacote \lstinline|jakarta.validation.constraints| 
   \begin{block}{Principais anotações}
       \begin{itemize}
           \item \lstinline|@NotNull| - Define que um campo não possa ser nulo.
           \item \lstinline|@NotEmpty| - Define que um campo não possar ser vazio. Collections, arrays e strings.
           \item \lstinline|@Max| - Define o valor máximo para um inteiro.
           \item \lstinline|@Min| - Define o valor minímo para um inteiro.
           \item \lstinline|@Size| - Define o tamanho para uma String.
           \item \lstinline|@Email| - Define que um campo deve conter um email válido.
       \end{itemize}
   \end{block}
\end{frame}

\begin{frame}[fragile]{Integração com o Spring Boot}
    Basta utilizar a seguinte dependência no pom.xml
\begin{lstlisting}[language=XML]
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-validation</artifactId>
</dependency>
\end{lstlisting}
E podemos adicionar a anotação \lstinline|@Valid| na Controller:
\begin{lstlisting}[language=Java]
        @PostMapping("/alunos")
	public @ResponseBody 
        Aluno postAluno(@Valid @RequestBody Aluno a) {
		return alunosService.salvaAluno(a);
	}
\end{lstlisting}

\end{frame}


\begin{frame}[fragile]{Classe Aluno com campos válidos}
\begin{lstlisting}[language=Java]
public class Aluno {

	@Id
	@Column
	@NotNull
	private String matricula;

	@Size(min = 3, max = 50)
	@Column
	private String nome;

	@Min(value = 18)
	@Column
	private int idade;

  /** todos os métodos foram ocultados **/
}
\end{lstlisting}

\end{frame}

\subsection{Criando as nossas próprias Exceptions}
\begin{frame}[fragile]{Exception: Aluno não encontrado}
    Caso busque um aluno que não há cadastro de sua matrícula.
\begin{lstlisting}[language=Java]
public class AlunoNaoEncontradoException extends RuntimeException {


	public AlunoNaoEncontradoException(String matricula) {
		super("O aluno de matricula " + matricula 
                    + " não existe");
	}
}
\end{lstlisting}

\end{frame}
\begin{frame}[fragile]{Exception: Conflito matrícula}
    O sistema não pode permitir mais de um aluno com a mesma matrícula.
\begin{lstlisting}[language=Java]
public class ConflitoMatriculaAlunoException extends RuntimeException{

	public ConflitoMatriculaAlunoException(String matricula) {
		super("A matricula " + matricula 
                    + " pertence a outro aluno");
	}	
}
\end{lstlisting}

\end{frame}

\subsection{Tratando erros no Spring Boot}

\begin{frame}{Técnicas de tratamento de falhas no Spring Boot}
    O Spring Boot possui uma abordagem centralizada para tratamento de erros.
    Sendo assim, um módulo único dedicado somente para tratar de erros. A \lstinline|@ControllerAdvice|.

\end{frame}

\begin{frame}[fragile]{ControllerAdvice: tratando erros}
\begin{lstlisting}[language=Java]
@ControllerAdvice
public class Sga2ExceptionHandler {

	@ExceptionHandler(value = AlunoNaoEncontradoException.class)
	public ResponseEntity<String> 
            handleAlunoNaoEncontradoException(
                AlunoNaoEncontradoException ex) {
		return ResponseEntity.status(HttpStatus.NOT_FOUND)
				.body(ex.getMessage());
	}

	@ExceptionHandler(value = ConflitoMatriculaAlunoException.class)
	public ResponseEntity<String> 
            handleAlunoNaoEncontradoException(
                ConflitoMatriculaAlunoException ex) {
		return ResponseEntity.status(HttpStatus.CONFLICT)
				.body(ex.getMessage());
	}

}
\end{lstlisting}

\end{frame}

\section{Lançando Exceções com tipos opcionais}

\subsection{Tipos opcionais}

\begin{frame}{Tipos opcionais}
    Os tipos opcionais se expressam pelos objetos envoltos por um \lstinline|Optional|.
    O \lstinline|Optional| em Java tem o objetivo de reduzir a incidência de \lstinline|NullPointerException|
    , então os objetos opcionais abstraem a tarefa de ficar checando se um determinado objeto é null. 
    Além disso, provê uma inferface simplificada para o usuário utilizar. \textbf{Os tipos opcionais não são exclusivos do Spring Boot!}

\end{frame}



\begin{frame}[fragile]{Exemplo sem e com Optional}

\begin{lstlisting}
public char buscaCaracter(String s, int index) {
    if (s == null) return '';
    if (s.length() <= index) return '';
    return s.charAt(index);
}


public char buscaCaracter(String s, int index) {
    return Optional.ofNullable(s)
        .filter(str -> str.length() <= index)
        .map(str -> str.charAt(index))
        .orElse('');
}

\end{lstlisting}
\end{frame}


\begin{frame}[fragile]{Principais métodos}
   \begin{block}{Principais métodos}
       \begin{itemize}
           \item \lstinline|.isPresent()| - Devolve se optional está preenchido.
           \item \lstinline|.get()| - Pega o valor dentro do optional, caso exista.
           \item \lstinline|.filter(Predicate<T> t)| - Aplica um filtro ao valor caso não seja null.
           \item \lstinline|.map(Function<T, U>)| - Mapeia o optional para outro tipo caso não seja null.
           \item \lstinline|.orElse(T t)| - Devolve o valor do opional caso esteja presente, senão devolve um valor padrão.
           \item \lstinline|.orElseThrow(Supplier<X> s)| - Lança uma exceção caso o optional esteja vazio.
       \end{itemize}
   \end{block}

\end{frame}

\begin{frame}[fragile]{Exemplo de Optional utilizado com o Java Stream}

\begin{lstlisting}
public static void main(String[] args) {
    var i = List.of(1, 2, 3)
            .stream()
            .filter(e -> e % 2 == 1)
            .findFirst() // método que devolve um Optional
            .filter(e -> e > 0)
            .map(e -> e + 1)
            .orElse(-1);
    System.out.println(i);
}
\end{lstlisting}
\end{frame}

\begin{frame}[fragile]{Exemplo de Optional lançando nossa Exceção}

\begin{lstlisting}
public Aluno buscaAlunoPelaMatricula(String matricula) {
    return alunosRepository.findById(matricula)
        .orElseThrow(() -> new AlunoNaoEncontradoException(matricula));
}
\end{lstlisting}
\end{frame}

\begin{frame}[fragile]{Obrigado!!}
        Muito obrigado pela atenção! Alguma dúvida? Bora praticar!!!
        \begin{block}{  }
                "\textit{Até a vitória, sempre! "}
        \end{block}
\end{frame}

\end{document}
